<!doctype html>
<html lang="{{ site.Language.LanguageCode | default `fr-FR` }}">
  <head>
    {{ partial "head.html" . }}
  </head>
  <body class="site-body">
    <a href="#main-content" class="skip-link">Aller au contenu</a>
    {{ partial "header.html" . }}
    <main id="main-content" class="site-main container-feroce py-10 sm:py-12">
      {{ partial "breadcrumbs.html" . }}
      {{ block "main" . }}{{ end }}
    </main>
    {{ partial "footer.html" . }}
    <script>
      (() => {
        const key = "fd-theme";
        const root = document.documentElement;
        const button = document.getElementById("theme-toggle");
        const metaTheme = document.getElementById("theme-color-meta");
        if (!button) return;

        const labels = { light: "Activer le mode sombre", dark: "Activer le mode clair" };
        const colors = { light: "#f8eaf3", dark: "#16131a" };

        const applyTheme = (theme) => {
          root.setAttribute("data-theme", theme);
          button.setAttribute("aria-pressed", String(theme === "dark"));
          button.setAttribute("aria-label", labels[theme] || labels.light);
          button.setAttribute("title", labels[theme] || labels.light);
          button.setAttribute("data-theme", theme);
          if (metaTheme) metaTheme.setAttribute("content", colors[theme] || colors.light);
          // Notify optional integrations (ex: Mermaid) so they can sync theme without reload.
          document.dispatchEvent(new CustomEvent("fd:theme-change", { detail: { theme } }));
        };

        const current = root.getAttribute("data-theme") === "dark" ? "dark" : "light";
        applyTheme(current);

        button.addEventListener("click", () => {
          const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
          applyTheme(next);
          try {
            localStorage.setItem(key, next);
          } catch (_) {}
        });
      })();
    </script>
    {{ if .Page.Store.Get "hasMermaid" }}
      <script src="{{ "vendor/mermaid.min.js" | relURL }}"></script>
      <script>
        (() => {
          if (typeof mermaid === "undefined") return;
          const getTheme = () =>
            document.documentElement.getAttribute("data-theme") === "dark" ? "dark" : "default";

          const renderMermaid = () => {
            const nodes = Array.from(document.querySelectorAll("pre.mermaid"));
            if (!nodes.length) return;

            // Restore original source before each render, otherwise Mermaid keeps transformed SVG.
            for (const node of nodes) {
              if (!node.dataset.mermaidSource) {
                node.dataset.mermaidSource = node.textContent || "";
              }
              node.removeAttribute("data-processed");
              node.textContent = node.dataset.mermaidSource;
            }

            mermaid.initialize({
              startOnLoad: false,
              securityLevel: "strict",
              theme: getTheme(),
            });

            mermaid.run({ querySelector: "pre.mermaid" });
          };

          renderMermaid();
          document.addEventListener("fd:theme-change", renderMermaid);
        })();
      </script>
    {{ end }}
  </body>
</html>
