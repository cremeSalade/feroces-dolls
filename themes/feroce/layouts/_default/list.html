{{ define "main" }}
  {{/* Section-level guard: keep route alive but show a disabled message. */}}
  {{ $sectionKey := partial "page-section-key.html" (dict "page" .) }}
  {{ $sectionEnabled := partial "section-enabled.html" (dict "site" site "key" $sectionKey) }}

  {{ if and (ne $sectionKey "") (not $sectionEnabled) }}
    {{ partial "section-disabled.html" (dict "layout" "list" "title" .Title) }}
  {{ else }}
  <section class="space-y-8">
    <header class="space-y-8">
      <h2 class="text-3xl font-bold tracking-tight">{{ .Title }}</h2>
      {{ with .Content }}
        <div class="panel">
          <div class="copy max-w-none leading-7 text-zinc-800">
            {{ . }}
          </div>
        </div>
      {{ end }}
    </header>

    {{ if eq .Section "blog" }}
      {{ $visibleBlog := where .Pages "Date.Unix" "le" (now).Unix }}
      <div class="space-y-6">
        {{ range $visibleBlog.ByDate.Reverse }}
          {{ $page := . }}
          {{ $isTruncated := $page.Truncated }}
          {{ $imgURL := "" }}
          {{ $imgWidth := 0 }}
          {{ $imgHeight := 0 }}
          {{ with $page.Params.image }}
            {{ $imgData := partial "resolved-image.html" (dict
              "site" $.Site
              "path" .
              "resource_section" "/blog"
              "fill" "960x540 webp q75"
              "allow_external" true
            ) | transform.Unmarshal }}
            {{ $imgURL = index $imgData "url" }}
            {{ $imgWidth = index $imgData "width" }}
            {{ $imgHeight = index $imgData "height" }}
          {{ end }}

          <article class="card">
            {{ if $imgURL }}
              <div class="mb-4 aspect-video overflow-hidden rounded-lg border border-zinc-200 bg-zinc-100">
                <img
                  src="{{ $imgURL }}"
                  alt="{{ $page.Params.image_alt | default $page.Title }}"
                  loading="lazy"
                  decoding="async"
                  class="h-full w-full object-cover"
                  {{ if gt $imgWidth 0 }}width="{{ $imgWidth }}" height="{{ $imgHeight }}"{{ end }}
                >
              </div>
            {{ end }}
            <h3 class="text-xl font-semibold">
              <a href="{{ $page.RelPermalink }}" class="hover:underline">{{ $page.Title }}</a>
            </h3>
            <p class="mt-1 text-sm text-zinc-500">{{ $page.Date.Format "02/01/2006" }}</p>
            <div class="copy mt-2 text-zinc-700{{ if $isTruncated }} summary-fade{{ end }}">{{ $page.Summary }}</div>
            {{ if $isTruncated }}
              <p class="mt-3">
                <a href="{{ $page.RelPermalink }}" class="text-sm font-medium text-zinc-900 underline underline-offset-4 hover:text-zinc-700">
                  Lire plus...
                </a>
              </p>
            {{ end }}
          </article>
        {{ end }}
      </div>

    {{ else if eq .Section "agenda" }}
      {{ $events := .RegularPages.ByDate }}
      {{ $nowUnix := (now).Unix }}
      {{ $future := slice }}
      {{ $past := slice }}

      {{ range $events }}
        {{ $start := .Date }}
        {{ with .Params.start }}{{ $start = time.AsTime . }}{{ end }}
        {{ if ge ($start.Unix) $nowUnix }}
          {{ $future = $future | append . }}
        {{ else }}
          {{ $past = $past | append . }}
        {{ end }}
      {{ end }}

      {{ $monthNames := dict "1" "janvier" "2" "février" "3" "mars" "4" "avril" "5" "mai" "6" "juin" "7" "juillet" "8" "août" "9" "septembre" "10" "octobre" "11" "novembre" "12" "décembre" }}
      {{ $monthStarts := slice }}
      {{ $baseMonth := time.AsTime (printf "%s-01" (now.Format "2006-01")) }}
      {{ $todayKey := now.Format "2006-01-02" }}
      {{ range seq 4 }}
        {{ $offset := sub . 1 }}
        {{ $monthStarts = $monthStarts | append ($baseMonth.AddDate 0 $offset 0) }}
      {{ end }}

      <section class="space-y-6" aria-labelledby="agenda-calendrier">
        <h3 id="agenda-calendrier" class="text-xl font-semibold">Calendrier (à venir)</h3>
        <div class="grid gap-4 lg:grid-cols-2">
          {{ range $monthStarts }}
            {{ $monthStart := . }}
            {{ $monthKey := $monthStart.Format "2006-01" }}
            {{ $nextMonth := $monthStart.AddDate 0 1 0 }}
            {{ $daysInMonth := int (div (sub ($nextMonth.Unix) ($monthStart.Unix)) 86400) }}
            {{ $firstWeekday := mod (add (int $monthStart.Weekday) 6) 7 }}
            {{ $monthLabel := printf "%s %d" (strings.FirstUpper (index $monthNames (printf "%d" (int $monthStart.Month)))) $monthStart.Year }}

            <section class="panel p-4">
              <h4 class="text-base font-semibold">{{ $monthLabel }}</h4>
              <div class="mt-3 grid grid-cols-7 gap-1 text-center text-xs text-zinc-500">
                <span>L</span><span>Ma</span><span>Me</span><span>J</span><span>V</span><span>S</span><span>D</span>
                {{ if gt $firstWeekday 0 }}
                  {{ range seq $firstWeekday }}
                    <span></span>
                  {{ end }}
                {{ end }}

                {{ range seq 1 $daysInMonth }}
                  {{ $day := . }}
                  {{ $dayKey := printf "%s-%02d" $monthKey $day }}
                  {{ $isToday := eq $dayKey $todayKey }}
                  {{ $hasEvent := false }}
                  {{ $targetID := "" }}
                  {{ range sort $future "Date" "asc" }}
                    {{ $eventStart := .Date }}
                    {{ with .Params.start }}{{ $eventStart = time.AsTime . }}{{ end }}
                    {{ if and (eq ($eventStart.Format "2006-01") $monthKey) (eq $eventStart.Day $day) }}
                      {{ $hasEvent = true }}
                      {{ if eq $targetID "" }}{{ $targetID = printf "agenda-event-%s" .File.TranslationBaseName }}{{ end }}
                    {{ end }}
                  {{ end }}

                  {{ if and $hasEvent (ne $targetID "") }}
                    <a href="#{{ $targetID }}" aria-label="Voir les évènements du {{ $day }}/{{ $monthStart.Format "01/2006" }}{{ if $isToday }} (aujourd'hui){{ end }}" class="agenda-day block min-h-12 rounded-md border border-zinc-400 bg-zinc-100 p-1 hover:bg-zinc-200 focus:outline-none focus:ring-2 focus:ring-zinc-400{{ if $isToday }} agenda-day-today{{ end }}">
                      <p class="agenda-day-number font-medium text-zinc-700">{{ $day }}</p>
                      <div class="mt-1 flex flex-wrap justify-center gap-1">
                        {{ range sort $future "Date" "asc" }}
                          {{ $eventStart := .Date }}
                          {{ with .Params.start }}{{ $eventStart = time.AsTime . }}{{ end }}
                          {{ if and (eq ($eventStart.Format "2006-01") $monthKey) (eq $eventStart.Day $day) }}
                            {{ $dotColor := .Params.color | default "#18181b" }}
                            <svg class="h-1.5 w-1.5" viewBox="0 0 6 6" aria-hidden="true" focusable="false">
                              <circle cx="3" cy="3" r="3" fill="{{ $dotColor }}"></circle>
                            </svg>
                          {{ end }}
                        {{ end }}
                      </div>
                    </a>
                  {{ else }}
                    <div class="agenda-day min-h-12 rounded-md border border-zinc-200 p-1{{ if $isToday }} agenda-day-today{{ end }}">
                      <p class="agenda-day-number font-medium text-zinc-700">{{ $day }}</p>
                    </div>
                  {{ end }}
                {{ end }}
              </div>
            </section>
          {{ end }}
        </div>
      </section>

      <section class="space-y-8" aria-labelledby="agenda-liste">
        <h3 id="agenda-liste" class="text-xl font-semibold">Liste des évènements</h3>

        <div class="space-y-4">
          <h4 class="text-base font-semibold">Évènements à venir</h4>
          {{ if gt (len $future) 0 }}
            {{ range sort $future "Date" "asc" }}
              {{ $event := . }}
              {{ $isTruncated := .Truncated }}
              {{ $start := .Date }}
              {{ with .Params.start }}{{ $start = time.AsTime . }}{{ end }}
              {{ $end := $start }}
              {{ $hasEnd := false }}
              {{ with .Params.end }}
                {{ $end = time.AsTime . }}
                {{ $hasEnd = true }}
              {{ end }}

              {{ $eventColor := .Params.color | default "#18181b" }}
              <article id="agenda-event-{{ .File.TranslationBaseName }}" class="panel relative overflow-hidden pl-6 scroll-mt-24">
                <svg class="pointer-events-none absolute inset-y-0 left-0 h-full w-1" viewBox="0 0 4 100" preserveAspectRatio="none" aria-hidden="true" focusable="false">
                  <rect x="0" y="0" width="4" height="100" fill="{{ $eventColor }}"></rect>
                </svg>
                <h4 class="text-lg font-semibold">
                  <a href="{{ .RelPermalink }}" class="hover:underline">{{ .Title }}</a>
                </h4>
                <p class="mt-1 text-sm text-zinc-600">{{ $start.Format "02/01/2006 15:04" }}{{ if $hasEnd }} - {{ $end.Format "02/01/2006 15:04" }}{{ end }}</p>
                {{ with .Params.location }}<p class="mt-1 text-sm text-zinc-700">{{ . }}</p>{{ end }}
                <div class="copy mt-3 text-sm leading-6 text-zinc-700{{ if $isTruncated }} summary-fade{{ end }}">{{ .Summary }}</div>
                {{ if $isTruncated }}
                  <p class="mt-3">
                    <a href="{{ .RelPermalink }}" class="text-sm font-medium text-zinc-900 underline underline-offset-4 hover:text-zinc-700">
                      Lire plus...
                    </a>
                  </p>
                {{ end }}
                <div class="mt-3 flex flex-wrap items-center gap-2">
                  {{ with .Params.tags }}
                    <ul class="flex flex-wrap gap-2">
                      {{ range . }}<li class="rounded-full bg-zinc-100 px-2 py-1 text-xs text-zinc-700">{{ . }}</li>{{ end }}
                    </ul>
                  {{ end }}
                  {{ with .OutputFormats.Get "ICS" }}
                    <a href="{{ .RelPermalink }}" download="{{ $event.File.TranslationBaseName }}.ics" class="btn btn-secondary ml-auto">
                      Ajouter à l'agenda
                    </a>
                  {{ end }}
                </div>
                {{ with .Params.post_ref }}
                  {{ $postRef := . }}
                  {{ with site.GetPage $postRef }}
                    <p class="mt-3 text-sm"><a href="{{ .RelPermalink }}" class="underline underline-offset-4 hover:text-zinc-900">Post lié: {{ .Title }}</a></p>
                  {{ else }}
                    <p class="mt-3 text-sm"><a href="{{ $postRef }}" class="underline underline-offset-4 hover:text-zinc-900">Post lié</a></p>
                  {{ end }}
                {{ end }}
              </article>
            {{ end }}
          {{ else }}
            <p class="text-sm text-zinc-600">Aucun évènement à venir.</p>
          {{ end }}
        </div>

        <div class="space-y-4">
          <h4 class="text-base font-semibold">Évènements passés</h4>
          {{ if gt (len $past) 0 }}
            {{ range sort $past "Date" "desc" }}
              {{ $isTruncated := .Truncated }}
              {{ $start := .Date }}
              {{ with .Params.start }}{{ $start = time.AsTime . }}{{ end }}
              {{ $end := $start }}
              {{ $hasEnd := false }}
              {{ with .Params.end }}
                {{ $end = time.AsTime . }}
                {{ $hasEnd = true }}
              {{ end }}

              {{ $eventColor := .Params.color | default "#71717a" }}
              <article class="panel agenda-past relative overflow-hidden pl-6">
                <svg class="pointer-events-none absolute inset-y-0 left-0 h-full w-1" viewBox="0 0 4 100" preserveAspectRatio="none" aria-hidden="true" focusable="false">
                  <rect x="0" y="0" width="4" height="100" fill="{{ $eventColor }}"></rect>
                </svg>
                <div class="flex items-start justify-between gap-3">
                  <h4 class="text-lg font-semibold">
                    <a href="{{ .RelPermalink }}" class="hover:underline">{{ .Title }}</a>
                  </h4>
                  <span class="shrink-0 rounded-full bg-zinc-200 px-2 py-0.5 text-[11px] font-semibold uppercase tracking-wide text-zinc-600">Passé</span>
                </div>
                <p class="mt-1 text-sm text-zinc-600">{{ $start.Format "02/01/2006 15:04" }}{{ if $hasEnd }} - {{ $end.Format "02/01/2006 15:04" }}{{ end }}</p>
                {{ with .Params.location }}<p class="mt-1 text-sm text-zinc-700">{{ . }}</p>{{ end }}
                <div class="copy mt-3 text-sm leading-6 text-zinc-700{{ if $isTruncated }} summary-fade{{ end }}">{{ .Summary }}</div>
                {{ if $isTruncated }}
                  <p class="mt-3">
                    <a href="{{ .RelPermalink }}" class="text-sm font-medium text-zinc-900 underline underline-offset-4 hover:text-zinc-700">
                      Lire plus...
                    </a>
                  </p>
                {{ end }}
                <div class="mt-3 flex flex-wrap items-center gap-2">
                  {{ with .Params.tags }}
                    <ul class="flex flex-wrap gap-2">
                      {{ range . }}<li class="rounded-full bg-zinc-100 px-2 py-1 text-xs text-zinc-700">{{ . }}</li>{{ end }}
                    </ul>
                  {{ end }}
                </div>
                {{ with .Params.post_ref }}
                  {{ $postRef := . }}
                  {{ with site.GetPage $postRef }}
                    <p class="mt-3 text-sm"><a href="{{ .RelPermalink }}" class="underline underline-offset-4 hover:text-zinc-900">Post lié: {{ .Title }}</a></p>
                  {{ else }}
                    <p class="mt-3 text-sm"><a href="{{ $postRef }}" class="underline underline-offset-4 hover:text-zinc-900">Post lié</a></p>
                  {{ end }}
                {{ end }}
              </article>
            {{ end }}
          {{ else }}
            <p class="text-sm text-zinc-600">Aucun évènement passé.</p>
          {{ end }}
        </div>
      </section>

    {{ else if eq .Section "ressources" }}
      <ul class="space-y-4">
        {{ range sort .Pages "Params.category" "asc" }}
          {{ $page := . }}
          {{ $media := "" }}
          {{ with $page.Params.image }}{{ $media = . }}{{ end }}
          {{ if eq $media "" }}{{ with $page.Params.icon }}{{ $media = . }}{{ end }}{{ end }}
          {{ if eq $media "" }}{{ with $page.Params.external_card }}{{ $media = . }}{{ end }}{{ end }}
          {{ if eq $media "" }}{{ with $page.Params.external_icon }}{{ $media = . }}{{ end }}{{ end }}
          {{ if eq $media "" }}{{ $media = "icons/resource-default.svg" }}{{ end }}
          {{ $thumbLink := $page.RelPermalink }}
          {{ $thumbExternal := false }}
          {{ with $page.Params.external_url }}
            {{ $thumbLink = . }}
            {{ $thumbExternal = true }}
          {{ else }}
            {{ with $page.Params.external_url_2 }}
              {{ $thumbLink = . }}
              {{ $thumbExternal = true }}
            {{ end }}
          {{ end }}
          <li class="panel">
            <div class="flex items-start gap-3">
              <div class="mt-0.5 shrink-0">
                <a href="{{ $thumbLink }}" class="resource-thumb-link" {{ if $thumbExternal }}target="_blank" rel="noreferrer"{{ end }}>
                  <img
                    src="{{ if or (hasPrefix $media "http://") (hasPrefix $media "https://") }}{{ $media | safeURL }}{{ else }}{{ $media | relURL }}{{ end }}"
                    alt=""
                    aria-hidden="true"
                    loading="lazy"
                    decoding="async"
                    class="resource-thumb"
                  >
                </a>
              </div>

              <div class="min-w-0 flex-1">
                <div class="flex items-start justify-between gap-3">
                  <span class="font-semibold text-zinc-900">{{ $page.Title }}</span>
                  <p class="shrink-0 text-xs uppercase tracking-wide text-zinc-500">{{ $page.Params.category }}</p>
                </div>

                {{ with $page.Params.external_url }}
                  <p class="mt-1 flex items-center gap-1 text-xs text-zinc-500">
                    <span class="shrink-0">Lien :</span>
                    <a href="{{ . }}" target="_blank" rel="noreferrer" title="{{ . }}" class="min-w-0 flex-1 truncate text-zinc-600 underline underline-offset-2 hover:text-zinc-900">{{ . }}</a>
                  </p>
                {{ end }}
                {{ with $page.Params.external_url_2 }}
                  <p class="mt-1 flex items-center gap-1 text-xs text-zinc-500">
                    <span class="shrink-0">Lien :</span>
                    <a href="{{ . }}" target="_blank" rel="noreferrer" title="{{ . }}" class="min-w-0 flex-1 truncate text-zinc-600 underline underline-offset-2 hover:text-zinc-900">{{ . }}</a>
                  </p>
                {{ end }}

                <div class="copy mt-1 text-sm leading-6 text-zinc-700">{{ $page.Content }}</div>
              </div>
            </div>
          </li>
        {{ end }}
      </ul>

    {{ else if eq .Section "glossaire" }}
      <ul class="space-y-4">
        {{ range .RegularPages.ByTitle }}
          <li class="panel">
            <div class="flex items-start justify-between gap-3">
              <h3 class="text-lg font-semibold">
                <a href="{{ .RelPermalink }}" class="hover:underline">{{ .Title }}</a>
              </h3>
              {{ with .Params.category }}
                <p class="shrink-0 text-xs uppercase tracking-wide text-zinc-500">{{ . }}</p>
              {{ end }}
            </div>
            {{ with .Params.synonyms }}
              <p class="mt-1 text-xs text-zinc-500">Synonymes: {{ delimit . ", " }}</p>
            {{ end }}
            <div class="copy mt-2 text-sm leading-6 text-zinc-700">{{ .Summary }}</div>
          </li>
        {{ end }}
      </ul>

    {{ else }}
      {{ if .Pages }}
        <ul class="space-y-4">
          {{ range .Pages.ByWeight }}
            <li class="panel">
              <a href="{{ .RelPermalink }}" class="font-semibold hover:underline">{{ .Title }}</a>
              <div class="copy mt-1 text-sm leading-6 text-zinc-700">{{ .Summary }}</div>
            </li>
          {{ end }}
        </ul>
      {{ end }}
    {{ end }}
  </section>
  {{ end }}
{{ end }}


